name: Run Service Checks
on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
    outputs:
      checks-status:
        type: string

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      checks-status: ${{ steps.final.outputs.checks-status }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ inputs.service }}/package-lock.json

      - name: Install dependencies (service)
        working-directory: ${{ inputs.service }}
        run: npm ci

      - name: Run Prettier / Lint
        working-directory: ${{ inputs.service }}
        run: |
          if npm run format:check --silent; then
            echo "lint=success"
          else
            echo "::error::Format/lint check failed"
            exit 1
          fi

      - name: Run unit tests
        working-directory: ${{ inputs.service }}
        run: |
          npm run test:unit --silent

      - name: Run coverage and enforce 90%
        working-directory: ${{ inputs.service }}
        run: |
          # run coverage (expect a coverage/coverage-summary.json)
          npm run test:coverage --silent || true
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "::error::Coverage summary not found at ${PWD}/coverage/coverage-summary.json"
            exit 1
          fi
          COVERAGE=$(node -e "const d=require('./coverage/coverage-summary.json'); console.log(d.total.lines.pct)")
          echo "Coverage for ${{ inputs.service }}: $COVERAGE%"
          # integer comparison
          python - <<PY
C = int(round(float("${COVERAGE}")))
if C < 90:
    raise SystemExit("coverage-failed")
print("OK")
PY
          echo "Coverage threshold satisfied"

      - name: Final status
        id: final
        run: |
          echo "checks-status=success" >> $GITHUB_OUTPUT
