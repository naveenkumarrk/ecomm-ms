name: CI Feature

on:
	pull_request:
		branches: [develop]
		types: [opened, synchronize, reopened, ready_for_review]

jobs:
	detect-changes:
		runs-on: ubuntu-latest
		outputs:
			services: ${{ steps.changes.outputs.services }}
			has-changes: ${{ steps.changes.outputs.has-changes }}
		steps:
			- uses: actions/checkout@v4
				with:
					fetch-depth: 0

			- name: Detect Changed Services
				id: changes
				run: |
					# Get changed files
					CHANGED_FILES=$(git diff --name-only origin/develop...HEAD)
					
					# Initialize services array
					SERVICES_ARRAY=()
					HAS_CHANGES="false"
					
					# Check each service directory
					for SERVICE in auth-worker cart-worker fulfillment-worker gateway-worker inventory-worker order-worker payment-worker product-worker; do
						if echo "$CHANGED_FILES" | grep -q "^$SERVICE/"; then
							SERVICES_ARRAY+=("$SERVICE")
							HAS_CHANGES="true"
						fi
					done
					
					# Check root changes (affects all services)
					if echo "$CHANGED_FILES" | grep -qE "^(package\.json|knip\.json|\.github/|\.prettierrc)"; then
						HAS_CHANGES="true"
						SERVICES_ARRAY=("auth-worker" "cart-worker" "fulfillment-worker" "gateway-worker" "inventory-worker" "order-worker" "payment-worker" "product-worker")
					fi
					
					# Convert array to JSON and space-separated string
					SERVICES_JSON=$(printf '%s\n' "${SERVICES_ARRAY[@]}" | jq -R . | jq -s .)
					SERVICES_STRING=$(IFS=' '; echo "${SERVICES_ARRAY[*]}")
					
					echo "services=$SERVICES_STRING" >> $GITHUB_OUTPUT
					echo "services-json=$SERVICES_JSON" >> $GITHUB_OUTPUT
					echo "has-changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
					
					if [ "$HAS_CHANGES" = "true" ]; then
						echo "Changed services: $SERVICES_STRING"
					else
						echo "No service changes detected"
					fi

	lint:
		runs-on: ubuntu-latest
		needs: detect-changes
		if: needs.detect-changes.outputs.has-changes == 'true'
		strategy:
			matrix:
				service: ${{ fromJson(needs.detect-changes.outputs.services-json) }}
		steps:
			- uses: actions/checkout@v4

			- name: Install jq
				run: sudo apt-get update && sudo apt-get install -y jq

			- uses: actions/setup-node@v4
				with:
					node-version: 20
					cache: 'npm'
					cache-dependency-path: ${{ matrix.service }}/package-lock.json

			- name: Install dependencies
				working-directory: ${{ matrix.service }}
				run: npm ci

			- name: Run Prettier
				working-directory: ${{ matrix.service }}
				run: npm run format:check

	knip-check:
		runs-on: ubuntu-latest
		needs: detect-changes
		if: needs.detect-changes.outputs.has-changes == 'true'
		steps:
			- uses: actions/checkout@v4

			- name: Install jq
				run: sudo apt-get update && sudo apt-get install -y jq

			- uses: actions/setup-node@v4
				with:
					node-version: 20
					cache: 'npm'

			- name: Install root dependencies
				run: npm ci

			- name: Run Knip
				run: npm run knip

	unit-tests:
		runs-on: ubuntu-latest
		needs: detect-changes
		if: needs.detect-changes.outputs.has-changes == 'true'
		strategy:
			fail-fast: false
			matrix:
				service: ${{ fromJson(format('[{0}]', join(split(needs.detect-changes.outputs.services, ' '), ','))) }}
		steps:
			- uses: actions/checkout@v4

			- name: Install jq
				run: sudo apt-get update && sudo apt-get install -y jq

			- uses: actions/setup-node@v4
				with:
					node-version: 20
					cache: 'npm'
					cache-dependency-path: ${{ matrix.service }}/package-lock.json

			- name: Install dependencies
				working-directory: ${{ matrix.service }}
				run: npm ci

			- name: Run unit tests
				working-directory: ${{ matrix.service }}
				run: npm run test:unit

	coverage-check:
		runs-on: ubuntu-latest
		needs: detect-changes
		if: needs.detect-changes.outputs.has-changes == 'true'
		strategy:
			fail-fast: false
			matrix:
				service: ${{ fromJson(format('[{0}]', join(split(needs.detect-changes.outputs.services, ' '), ','))) }}
		steps:
			- uses: actions/checkout@v4

			- name: Install jq
				run: sudo apt-get update && sudo apt-get install -y jq

			- uses: actions/setup-node@v4
				with:
					node-version: 20
					cache: 'npm'
					cache-dependency-path: ${{ matrix.service }}/package-lock.json

			- name: Install dependencies
				working-directory: ${{ matrix.service }}
				run: npm ci

			- name: Run coverage tests
				working-directory: ${{ matrix.service }}
				run: npm run test:coverage

			- name: Check coverage threshold
				working-directory: ${{ matrix.service }}
				run: |
					COVERAGE_FILE="${{ matrix.service }}/coverage/coverage-summary.json"
					if [ ! -f "$COVERAGE_FILE" ]; then
						echo "::error::Coverage file not found: $COVERAGE_FILE"
						exit 1
					fi
					
					# Extract coverage percentage using node
					COVERAGE=$(node -e "const data = require('./$COVERAGE_FILE'); console.log(data.total.lines.pct);")
					
					echo "Current coverage: $COVERAGE%"
					echo "Required coverage: 90%"
					
					# Compare coverage using node (no bc dependency needed)
					RESULT=$(node -e "console.log($COVERAGE >= 90 ? 'pass' : 'fail');")
					
					if [ "$RESULT" != "pass" ]; then
						echo "::error::Coverage $COVERAGE% is below required 90%"
						exit 1
					fi
					
					echo "✅ Coverage check passed: $COVERAGE%"

			- name: Upload coverage to artifacts
				uses: actions/upload-artifact@v4
				with:
					name: coverage-${{ matrix.service }}
					path: ${{ matrix.service }}/coverage/
					retention-days: 7

	pr-status:
		runs-on: ubuntu-latest
		needs: [lint, knip-check, unit-tests, coverage-check]
		if: always()
		steps:
			- name: Check all jobs status
				run: |
					if [ "${{ needs.lint.result }}" != "success" ] || \
					   [ "${{ needs.knip-check.result }}" != "success" ] || \
					   [ "${{ needs.unit-tests.result }}" != "success" ] || \
					   [ "${{ needs.coverage-check.result }}" != "success" ]; then
						echo "::error::One or more checks failed"
						exit 1
					fi
					echo "✅ All checks passed"

