name: CI Feature
on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ci-feature-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # 1) Run knip at repo root (dependency check)
  knip-check:
    runs-on: ubuntu-latest
    outputs:
      knip-status: ${{ steps.knip.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root deps
        run: npm ci

      - name: Run knip
        id: knip
        run: |
          if npm run knip --silent; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "::error::knip found issues"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  # 2) Detect changed services
  detect:
    needs: knip-check
    uses: ./.github/workflows/detect-changes.yaml
    with:
      base-ref: origin/develop
      compare-ref: HEAD

  # 3) Per-service checks (matrix)
  service-checks:
    needs: [detect, knip-check]
    if: needs.detect.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect.outputs.services-json) }}
    uses: ./.github/workflows/run-service-checks.yml
    with:
      service: ${{ matrix.service }}

  # 4) Auto-merge PR into develop if everything passed
  auto-merge:
    needs: [service-checks, knip-check]
    if: >
      needs.knip-check.outputs.knip-status == 'success' &&
      needs.service-checks.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Auto-merge PR into develop using PAT
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
          const pr = context.payload.pull_request;
          if (!pr) {
            core.setFailed("No pull_request in event payload");
            return;
          }

          const { owner, repo } = context.repo;
          const prNumber = pr.number;

          // Retrieve fresh PR data
          const { data: prData } = await github.rest.pulls.get({
            owner,
            repo,
            pull_number: prNumber
          });

          if (prData.state !== "open") {
            core.info(`PR #${prNumber} is not open. Skipping merge.`);
            return;
          }

          if (prData.mergeable === false) {
            core.info(`PR #${prNumber} is not mergeable. Skipping merge.`);
            return;
          }

          // Merge using squash
          await github.rest.pulls.merge({
            owner,
            repo,
            pull_number: prNumber,
            merge_method: "squash"
          });

          core.info(`PR #${prNumber} merged successfully.`);



  # 5) Notify Slack about CI result (success / failure)
  notify:
    needs: [auto-merge]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "<!here> CI Feature results for PR #${{ github.event.pull_request.number }}",
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": "*CI Feature Result*"} },
                { "type": "section", "fields": [
                    { "type": "mrkdwn", "text": "*Repo:*\n<{{ github.server_url }}/${{ github.repository }}>" },
                    { "type": "mrkdwn", "text": "*PR:*\n<#${{ github.event.pull_request.number }}|${{ github.event.pull_request.title }}>" },
                    { "type": "mrkdwn", "text": "*Result:*\n${{ needs.auto-merge.result }}" },
                    { "type": "mrkdwn", "text": "*Services:*\n${{ needs.detect.outputs.services }}" }
                ] }
              ]
            }
