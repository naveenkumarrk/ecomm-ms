name: CI Feature
on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ci-feature-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Check if PR is from feature/test branch
  check-branch:
    runs-on: ubuntu-latest
    outputs:
      is-feature-test: ${{ steps.check.outputs.is-feature-test }}
    steps:
      - name: Check if PR is from feature/test branch
        id: check
        run: |
          PR_HEAD_REF="${{ github.head_ref }}"
          if [ "$PR_HEAD_REF" = "feature/test" ]; then
            echo "is-feature-test=true" >> $GITHUB_OUTPUT
            echo "PR is from feature/test branch"
          else
            echo "is-feature-test=false" >> $GITHUB_OUTPUT
            echo "PR is from $PR_HEAD_REF, skipping"
          fi

  # 1) Detect changed services
  detect:
    needs: [check-branch]
    if: needs.check-branch.outputs.is-feature-test == 'true'
    uses: ./.github/workflows/detect-changes.yaml
    with:
      base-ref: origin/develop
      compare-ref: HEAD

  # 2) Per-service checks (matrix)
  service-checks:
    needs: [detect]
    if: needs.detect.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect.outputs.services-json) }}
    uses: ./.github/workflows/run-service-checks.yml
    with:
      service: ${{ matrix.service }}

  # 3) Auto-merge PR into develop if everything passed
  auto-merge:
    needs: [service-checks, detect]
    if: |
      needs.detect.outputs.has-changes == 'true' && 
      needs.service-checks.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Auto-merge PR into develop using PAT
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request in event payload");
              return;
            }

            const { owner, repo } = context.repo;
            const prNumber = pr.number;

            // Retrieve fresh PR data
            const { data: prData } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            if (prData.state !== "open") {
              core.info(`PR #${prNumber} is not open. Skipping merge.`);
              return;
            }

            if (prData.mergeable === false) {
              core.info(`PR #${prNumber} is not mergeable. Skipping merge.`);
              return;
            }

            // Merge using squash
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: prNumber,
              merge_method: "squash"
            });

            core.info(`PR #${prNumber} merged successfully.`);

  # 4) Notify Slack about CI result (success / failure)
  notify:
    needs: [auto-merge, detect, check-branch]
    if: always() && needs.check-branch.outputs.is-feature-test == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          SERVICES="${{ needs.detect.outputs.services || 'N/A' }}"
          PAYLOAD=$(cat <<EOF
          {
            "text": "<!here> CI Feature results for PR #${{ github.event.pull_request.number }}",
            "blocks": [
              { "type": "section", "text": { "type": "mrkdwn", "text": "*CI Feature Result*"} },
              { "type": "section", "fields": [
                  { "type": "mrkdwn", "text": "*Repo:*\n${{ github.server_url }}/${{ github.repository }}" },
                  { "type": "mrkdwn", "text": "*PR:*\n#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" },
                  { "type": "mrkdwn", "text": "*Result:*\n${{ needs.auto-merge.result || 'skipped' }}" },
                  { "type": "mrkdwn", "text": "*Services:*\n$SERVICES" }
              ] }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
